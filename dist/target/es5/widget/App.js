/*! stonewalljs 2016-04-20 */
"use strict";function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2}return Array.from(arr)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();define("templating/utils/List",[],function(){var List=function(){function List(items){_classCallCheck(this,List),this._map=new Map(items),this._indexes=[].concat(_toConsumableArray(this._map.keys())),this._onDelete=[]}return _createClass(List,[{key:"keys",value:function(){return this._indexes}},{key:"values",value:function(){return this.entries().map(function(entry){return entry[1]})}},{key:"entries",value:function(){var _this=this;return this._indexes.map(function(key){return[key,_this._map.get(key)]})}},{key:"get",value:function(key){return this._map.get(key)}},{key:"forEach",value:function(fn){return this.values().forEach(function(value,index){for(var _len=arguments.length,args=Array(_len>2?_len-2:0),_key=2;_len>_key;_key++)args[_key-2]=arguments[_key];return fn.apply(null,[value,index].concat(args))})}},{key:"getIndex",value:function(key){return this._indexes.indexOf(key)}},{key:"changeIndex",value:function(key,index){if(key){var indexes=this._indexes,indexOf=indexes.indexOf(key);-1!==indexOf&&index!==indexOf&&this._indexes.splice(index,0,this._indexes.splice(indexOf,1)[0])}}},{key:"getValueByIndex",value:function(index){return this._map.get(this._indexes[index])}},{key:"getKeyByIndex",value:function(index){return this._indexes[index]}},{key:"set",value:function(key,value,index){this._map.set(key,value),void 0!==index?this._indexes.splice(index,0,key):this._indexes.push(key)}},{key:"has",value:function(key){return this._map.has(key)}},{key:"clear",value:function(){this._map.clear(),this._indexes.splice(0,this._indexes.length)}},{key:"onDelete",value:function(cb){var chunk=function(){return cb.apply(void 0,arguments)};return this._onDelete.push(chunk),{remove:function(){this._onDelete.splice(this._onDelete.indexOf(chunk,1))}}}},{key:"delete",value:function(key){var _this2=this;this.has(key)&&!function(){var item=_this2._map.get(key);_this2._map["delete"](key),_this2._indexes.splice(_this2._indexes.indexOf(key),1),_this2._onDelete.forEach(function(chunk){return chunk(key,_this2.size,item)})}()}},{key:"deleteByIndex",value:function(index){this["delete"](this._indexes[index])}},{key:"first",get:function(){return this.getValueByIndex(0)}},{key:"last",get:function(){return this.getValueByIndex(this._indexes.length-1)}},{key:"size",get:function(){return this._map.size}}]),List}();return List}),define("templating/dom",[],function(){function isObject(obj){var type="undefined"==typeof obj?"undefined":_typeof(obj);return"function"===type||"object"===type&&!!obj}function createPlaceholder(tag){var placeholder=document.createElement(tag||"div");return placeholder.setAttribute("style","display:none;"),placeholder}function destroy(instance){var keys=Object.keys(instance);keys.length>0&&keys.forEach(function(key){if("root"!==key){var children=instance[key];void 0!==children.elGroup&&children.elGroup.size>0&&children.elGroup.forEach(function(child){void 0!==child&&void 0!==child.remove&&child.remove(!0)})}})}var Element=function(){function Element(el,node){_classCallCheck(this,Element),this.el=el,this._events=[],this.name=node.name||node.data.name;var data=this.data=node.data;data&&data.bind&&(this.bind=data.bind)}return _createClass(Element,[{key:"clone",value:function(){return this.run.apply(this,arguments)}},{key:"text",value:function(_text){dom.text(this,_text)}},{key:"detach",value:function(){dom.detach(this)}},{key:"attach",value:function(){dom.attach(this)}},{key:"changePosition",value:function(index){dom.changePosition(this,index)}},{key:"setAttribute",value:function(prop,value){dom.setAttribute(this,prop,value)}},{key:"getAttribute",value:function(prop){return dom.getAttribute(this,prop)}},{key:"removeAttribute",value:function(prop){dom.removeAttribute(this,prop)}},{key:"setStyle",value:function(prop,value){dom.setStyle(this,prop,value)}},{key:"getStyle",value:function(prop){return dom.getStyle(this,prop)}},{key:"removeStyle",value:function(prop){dom.removeStyle(this,prop)}},{key:"addClass",value:function(className){dom.addClass(this,className)}},{key:"hasClass",value:function(className){return dom.hasClass(this,className)}},{key:"removeClass",value:function(className){dom.removeClass(this,className)}},{key:"val",value:function(_val){return dom.val(this,_val)}},{key:"on",value:function(event,cb,context){var args=Array.prototype.slice.call(arguments,0);return dom.on.apply(!1,[this].concat(args))}},{key:"onDOMAttached",value:function(){return dom.onDOMAttached(this)}},{key:"remove",value:function(force){dom.remove(this,force)}}]),Element}(),dom={detach:function(node){node.placeholder instanceof HTMLElement==!1&&(node.placeholder=createPlaceholder(node.data.tag||node.el.tagName)),node&&node.el&&node.el.parentNode&&node.el.parentNode.replaceChild(node.placeholder,node.el)},attach:function(node){node&&node.el&&node.placeholder&&node.placeholder.parentNode&&node.placeholder.parentNode.replaceChild(node.el,node.placeholder)},append:function(parent,child){void 0!==parent.el&&void 0!==child.el&&parent.el.appendChild(child.el)},prepend:function(parent,child){dom.insertBefore(parent,child,0)},insertBefore:function(parent,child,index){var parentEl=parent.el,childEl=child.el;void 0!==parentEl&&void 0!==childEl&&(void 0!==parentEl.childNodes[index]?parentEl.insertBefore(childEl,parentEl.childNodes[index]):parentEl.appendChild(childEl))},changePosition:function(el,index){var HTMLElement=el.el;if(HTMLElement&&HTMLElement.parentNode){var parentNode=HTMLElement.parentNode,elGroup=el.elGroup,size=elGroup.size,target=elGroup.getKeyByIndex(index)||elGroup.getLast();target!==HTMLElement&&(size-1>=index?parentNode.insertBefore(HTMLElement,target):null!==target.nextSibling?parentNode.insertBefore(HTMLElement,target.nextSibling):parentNode.appendChild(HTMLElement),el.elGroup.changeIndex(HTMLElement,index))}},text:function(node,_text2){node&&node.el&&(node.el.innerHTML=_text2)},setAttribute:function(node,prop,value){node&&node.el&&(isObject(prop)?Object.keys(prop).forEach(function(key){node.el.setAttribute(key,prop[key])}):node.el.setAttribute(prop,value))},getAttribute:function(node,prop){return node&&node.el?node.el.getAttribute(prop):void 0},removeAttribute:function(node,prop){node&&node.el&&node.el.removeAttribute(prop)},setStyle:function(node,prop,value){node&&node.el&&(isObject(prop)?Object.keys(prop).forEach(function(key){node.el.style[key]=prop[key]}):node.el.style[prop]=value)},getStyle:function(node,prop){return node&&node.el&&void 0!==node.el&&void 0!==node.el.style?node.el.style[prop]:void 0},removeStyle:function(node,prop){node&&node.el&&(node.el.style[prop]="")},addClass:function(node,className){node&&node.el&&node.el.classList.add(className)},hasClass:function(node,className){return node&&node.el?node.el.classList.contains(className):!1},removeClass:function(node,className){node&&node.el&&node.el.classList.remove(className)},val:function(node,_val2){if(node&&node.el){var el=node.el;if(void 0===_val2)return el.value;el.value=_val2}},on:function(element,ev,cb,context){for(var _len2=arguments.length,args=Array(_len2>4?_len2-4:0),_key2=4;_len2>_key2;_key2++)args[_key2-4]=arguments[_key2];var _this3=this,el=element.el,events=ev.split(" "),fn=function(e){cb.apply(context||_this3,[e,element].concat(args))};events.forEach(function(event){el.addEventListener(event,fn)});var evt={remove:function(){events.forEach(function(event){return el.removeEventListener(event,fn)});var evts=element._events;evts.splice(evts.indexOf(evt),1)}};return element._events.push(evt),evt},remove:function(el){for(;el._events.length>0;)el._events.shift().remove();el.children&&destroy(el.children),void 0!==el.elGroup&&el.elGroup["delete"](el.el),void 0!==el.el&&(el.el.remove?el.el.remove():el.el.parentNode&&el.el.parentNode.removeChild(el.el),delete el.el)},onDOMAttached:function(el){var _this4=this,handlers=[],attached=!1,_step=void 0;return void 0!==el.el&&(_step=function(){if(attached)for(;handlers.length>0;)handlers.shift()();else window.requestAnimationFrame(_step),document.body.contains(el.el)&&(attached=!0)}),{then:function(cb,context){handlers.push(cb.bind(context||_this4)),window.requestAnimationFrame(_step)}}},Element:Element};return dom}),function(root,factory){"function"==typeof define&&define.amd?define("templating/DomFragment",factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory())}(void 0,function(){function createPlaceholder(tag){var placeholder=document.createElement(tag||"div");return placeholder.setAttribute("style","display:none;"),placeholder}var DomFragment=function(){function DomFragment(_node,placeholder,childNodes,elGroup,index,obj){return _classCallCheck(this,DomFragment),Object.assign(this,{_node:_node,placeholder:placeholder,childNodes:childNodes,elGroup:elGroup,index:index,obj:obj}),this.render()}return _createClass(DomFragment,[{key:"applyAttributes",value:function(el){var attributes=this._node.data.attribs;Object.keys(attributes).forEach(function(key){el.setAttribute(key,attributes[key])})}},{key:"applyFragment",value:function(el){var node=this._node,plFragment=node.template();if(plFragment)for(;plFragment.childNodes.length>0;)el.appendChild(plFragment.childNodes[0])}},{key:"appendToBody",value:function(el){var elGroup=this.elGroup,placeholder=this.placeholder,size=elGroup.size;if(size>0){var index=void 0===this.index||this.index>size-1?size-1:this.index-1,target=elGroup.keys()[-1!==index?index:0],parentNode=target.parentNode;-1===index?parentNode.insertBefore(el,target):null!==target.nextSibling?parentNode.insertBefore(el,target.nextSibling):parentNode.appendChild(el)}else{var _parentNode=placeholder.parentNode;_parentNode&&_parentNode.replaceChild(el,placeholder)}}},{key:"render",value:function(){var placeholder=this.placeholder,node=this._node,keep=!placeholder.id&&0===this.elGroup.size,instance=node.tmpEl(keep?placeholder:!1,this.obj,this.childNodes,node),el=instance.el||createPlaceholder(node.data.tag);return keep||node.replace?node.replace||(el.innerHTML=""):this.applyAttributes(el),node.replace||this.applyFragment(el),this.appendToBody(el),instance.ready&&instance.ready(el),instance}}]),DomFragment}();return DomFragment}),function(root,factory){"function"==typeof define&&define.amd?define("templating/Decoder",["./utils/List","./dom","./DomFragment"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./utils/List"),require("./dom"),require("./DomFragment")))}(void 0,function(List,dom,DomFragment){function isObject(obj){return obj===Object(obj)}function isArray(obj){return Array.isArray?Array.isArray(obj):"[object Array]"===toString.call(obj)}var _decoders={},Decoder=function(){function Decoder(root){_classCallCheck(this,Decoder),this._root="string"==typeof root?JSON.parse(root):root,root.children&&root.children.length>0&&(this.children=this._parseElements(root.children))}return _createClass(Decoder,null,[{key:"addDecoder",value:function(decoder){void 0===_decoders[decoder.tagName]&&(_decoders[decoder.tagName]=decoder)}}]),_createClass(Decoder,[{key:"renderFragment",value:function(template,tag){var el=document.createElement("template");return void 0===el.content&&("td"===tag?el=document.createElement("tr"):"tr"===tag&&(el=document.createElement("tbody"))),el.innerHTML=template,void 0!==el.content?el.content.firstChild:el.firstChild}},{key:"_parseElements",value:function(nodeList){var _this5=this,context={};return nodeList.forEach(function(node){var name=node.data.name,tagName=node.tagName;if(tagName){var decodedData=_decoders[tagName].decode(node);if(decodedData){var nodeParams={name:decodedData.name,data:decodedData.data,tmpEl:decodedData.tmpEl,parse:decodedData.parse,replace:decodedData.replace,id:node.id,template:function(){return _this5.renderFragment(node.template,node.data.tag)},noAttach:_decoders[tagName].noAttach||node.data.tplSet.noattach};node.children&&node.children.length>0&&(nodeParams.children=_this5._parseElements(node.children)),context[name]=nodeParams}}else name&&(context[name]={id:node.id,data:node.data,name:name})}),context}},{key:"renderTemplate",value:function(){var childNodes=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],_this6=this,obj=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],fragment=arguments[2],resp={},_runAll=[];Object.keys(childNodes).forEach(function(name){var childFragment=fragment,child=childNodes[name],children=child.children,elGroup=new List,placeholder=document.createElement(child.data.tplSet.tag||"div");if(placeholder.setAttribute("style","display:none;"),placeholder.id=child.id,elGroup.onDelete(function(key,size){0===size&&key.parentNode&&(key.parentNode.replaceChild(placeholder,key),childFragment=function(){return placeholder})}),child.template)!function(){var run=function run(force,index){var template=childFragment();force instanceof HTMLElement==!0&&(template=force);var childNodes=void 0,data=template!==force&&(isObject(force)||isArray(force))?force:obj;if(!child.noAttach||force){var _placeholder=template.querySelector("#"+child.id)||template;children&&(childNodes=_this6.renderTemplate(children,data,function(){return template}));var element=new DomFragment(child,_placeholder,childNodes,elGroup,index,data);return template=element.el,childNodes&&childNodes.runAll&&child.parse&&childNodes.runAll(),childNodes&&!element.children&&(element.children=childNodes),element.elGroup=elGroup,element.run=run,elGroup.set(element.el,element,index),element}};_runAll.push(run),resp[name]={data:child.data,run:run,elGroup:elGroup}}();else{var element=new dom.Element(childFragment().querySelector("#"+child.id),child);element.removeAttribute("id"),element.elGroup=elGroup,elGroup.set(element.el,element),resp[name]=element}});var setProp=function(obj,name,fn){Object.defineProperty(obj,name,{enumerable:!1,value:fn})},runAll=function(el){return _runAll.forEach(function(run){return run(el)}),resp};return setProp(resp,"runAll",runAll),resp}},{key:"render",value:function(obj){var fragment=this.renderFragment(this._root.template);return{fragment:fragment,children:this.renderTemplate(this.children,obj,function(){return fragment}).runAll(),templateId:this._root.templateId}}}]),Decoder}();return Decoder}),function(root,factory){"function"==typeof define&&define.amd?define("coders/component/cpDecoder",["templating/Decoder"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./Decoder")))}(void 0,function(Decoder){var componentDecoder={tagName:"cp",decode:function(node){var data=node.data,response={name:data.name,replace:!0,tmpEl:function(placeholder,obj,children,node){var instance=new data.src(data.dataset,children,obj,node);return instance},data:data||{}};return void 0!==data.dataset.bind&&(response.bind=data.dataset.bind),response}};return Decoder&&Decoder.addDecoder(componentDecoder),componentDecoder}),function(root,factory){"function"==typeof define&&define.amd?define("coders/placeholders/plDecoder",["templating/Decoder","templating/dom"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./Decoder"),require("./dom")))}(void 0,function(Decoder,dom){var componentDecoder={tagName:"pl",decode:function(node){var data=node.data;return{name:data.name,tmpEl:function(el,obj,children,node){return new dom.Element(el||document.createElement(data.tag),node)},parse:!0,data:data}}};return Decoder&&Decoder.addDecoder(componentDecoder),componentDecoder}),function(root,factory){"function"==typeof define&&define.amd?define("coders/databind/bdDecoder",["templating/Decoder","templating/dom"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./Decoder"),require("./dom")))}(void 0,function(Decoder,dom){var bindingsDecoder={tagName:"bd",noAttach:!0,decode:function(node){var data=this.data=node.data,response={name:data.name,tmpEl:function(el,obj,children,node){return new dom.Element(el||document.createElement(data.tag),node)},data:data};return response}};return Decoder&&Decoder.addDecoder(bindingsDecoder),bindingsDecoder}),function(root,factory){"function"==typeof define&&define.amd?define("coders/router/routerDecoder",["templating/Decoder","templating/dom"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./Decoder"),require("./dom")))}(void 0,function(Decoder,dom){var componentDecoder={tagName:"rt",noAttach:!0,decode:function(node){var data=node.data,response={name:data.name,tmpEl:function(el,obj,children,node){return new dom.Element(el||document.createElement(data.tag),node)},parse:!0,data:data||{}};return response}};return Decoder&&Decoder.addDecoder(componentDecoder),componentDecoder}),function(root,factory){"function"==typeof define&&define.amd?define("coders/style/styleDecoder",["templating/Decoder"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./Decoder")))}(void 0,function(Decoder){var styleDecoder={tagName:"style",decode:function(node){if(void 0===node.data.styleAttached){node.data.styleAttached=!0;var style=node.data.style,addStyle=function(style){var tag=document.createElement("style");tag.innerHTML=style,document.head.appendChild(tag)};"string"==typeof style?addStyle(style):style.then(addStyle)}}};return Decoder&&Decoder.addDecoder(styleDecoder),styleDecoder}),function(factory){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=factory():"function"==typeof define&&define.amd?define("watch",factory):(window.WatchJS=factory(),window.watch=window.WatchJS.watch,window.unwatch=window.WatchJS.unwatch,window.callWatchers=window.WatchJS.callWatchers)}(function(){var WatchJS={noMore:!1},lengthsubjects=[],isFunction=function(functionToCheck){var getType={};return functionToCheck&&"[object Function]"==getType.toString.call(functionToCheck)},isArray=function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},getObjDiff=function(a,b){var aplus=[],bplus=[];if("string"!=typeof a&&"string"!=typeof b){if(isArray(a))for(var i=0;i<a.length;i++)void 0===b[i]&&aplus.push(i);else for(var i in a)a.hasOwnProperty(i)&&void 0===b[i]&&aplus.push(i);if(isArray(b))for(var j=0;j<b.length;j++)void 0===a[j]&&bplus.push(j);else for(var j in b)b.hasOwnProperty(j)&&void 0===a[j]&&bplus.push(j)}return{added:aplus,removed:bplus}},clone=function(obj){if(null==obj||"object"!=("undefined"==typeof obj?"undefined":_typeof(obj)))return obj;var copy=obj.constructor();for(var attr in obj)copy[attr]=obj[attr];return copy},defineGetAndSet=function(obj,propName,getter,setter){try{Object.defineProperty(obj,propName,{get:getter,set:setter,enumerable:!0,configurable:!0})}catch(e2){try{Object.prototype.__defineGetter__.call(obj,propName,getter),Object.prototype.__defineSetter__.call(obj,propName,setter)}catch(e3){throw new Error("watchJS error: browser not supported :/")}}},defineProp=function(obj,propName,value){try{Object.defineProperty(obj,propName,{enumerable:!1,configurable:!0,writable:!1,value:value})}catch(error){obj[propName]=value}},watch=function(){isFunction(arguments[1])?watchAll.apply(this,arguments):isArray(arguments[1])?watchMany.apply(this,arguments):watchOne.apply(this,arguments)},watchAll=function(obj,watcher,level,addNRemove){if("string"!=typeof obj&&(obj instanceof Object||isArray(obj))){var props=[];if(isArray(obj))for(var prop=0;prop<obj.length;prop++)props.push(prop);else for(var prop2 in obj)"$val"!=prop2&&Object.prototype.hasOwnProperty.call(obj,prop2)&&props.push(prop2);watchMany(obj,props,watcher,level,addNRemove),addNRemove&&pushToLengthSubjects(obj,"$$watchlengthsubjectroot",watcher,level)}},watchMany=function(obj,props,watcher,level,addNRemove){if("string"!=typeof obj&&(obj instanceof Object||isArray(obj)))for(var i=0;i<props.length;i++){var prop=props[i];watchOne(obj,prop,watcher,level,addNRemove)}},watchOne=function(obj,prop,watcher,level,addNRemove){"string"!=typeof obj&&(obj instanceof Object||isArray(obj))&&(isFunction(obj[prop])||(null!=obj[prop]&&(void 0===level||level>0)&&watchAll(obj[prop],watcher,void 0!==level?level-1:level),defineWatcher(obj,prop,watcher,level),addNRemove&&(void 0===level||level>0)&&pushToLengthSubjects(obj,prop,watcher,level)))},unwatch=function(){isFunction(arguments[1])?unwatchAll.apply(this,arguments):isArray(arguments[1])?unwatchMany.apply(this,arguments):unwatchOne.apply(this,arguments)},unwatchAll=function(obj,watcher){if(!(obj instanceof String)&&(obj instanceof Object||isArray(obj)))if(isArray(obj)){for(var props=[],prop=0;prop<obj.length;prop++)props.push(prop);unwatchMany(obj,props,watcher)}else{var unwatchPropsInObject=function unwatchPropsInObject(obj2){var props=[];for(var prop2 in obj2)obj2.hasOwnProperty(prop2)&&(obj2[prop2]instanceof Object?unwatchPropsInObject(obj2[prop2]):props.push(prop2));unwatchMany(obj2,props,watcher)};unwatchPropsInObject(obj)}},unwatchMany=function(obj,props,watcher){for(var prop2 in props)props.hasOwnProperty(prop2)&&unwatchOne(obj,props[prop2],watcher)},defineWatcher=function(obj,prop,watcher,level){var val=obj[prop];watchFunctions(obj,prop),obj.watchers||defineProp(obj,"watchers",{});var newWatcher=!1;obj.watchers[prop]||(obj.watchers[prop]=[],newWatcher=!0);for(var i=0;i<obj.watchers[prop].length;i++)if(obj.watchers[prop][i]===watcher)return;if(obj.watchers[prop].push(watcher),newWatcher){var getter=function(){return val},setter=function(newval){var oldval=val;val=newval,0!==level&&obj[prop]&&watchAll(obj[prop],watcher,void 0===level?level:level-1),watchFunctions(obj,prop),WatchJS.noMore||oldval!==newval&&(callWatchers(obj,prop,"set",newval,oldval),WatchJS.noMore=!1)};defineGetAndSet(obj,prop,getter,setter)}},callWatchers=function callWatchers(obj,prop,action,newval,oldval){if(void 0!==prop)for(var wr=0;wr<obj.watchers[prop].length;wr++)obj.watchers[prop][wr].call(obj,prop,action,newval,oldval);else for(var prop in obj)obj.hasOwnProperty(prop)&&callWatchers(obj,prop,action,newval,oldval)},methodNames=["pop","push","reverse","shift","sort","slice","unshift","splice"],defineArrayMethodWatcher=function(obj,prop,original,methodName){defineProp(obj[prop],methodName,function(){var response=original.apply(obj[prop],arguments);return watchOne(obj,obj[prop]),"slice"!==methodName&&callWatchers(obj,prop,methodName,arguments),response})},watchFunctions=function(obj,prop){if(obj[prop]&&!(obj[prop]instanceof String)&&isArray(obj[prop]))for(var methodName,i=methodNames.length;i--;)methodName=methodNames[i],defineArrayMethodWatcher(obj,prop,obj[prop][methodName],methodName)},unwatchOne=function(obj,prop,watcher){for(var i=0;i<obj.watchers[prop].length;i++){var w=obj.watchers[prop][i];w==watcher&&obj.watchers[prop].splice(i,1)}removeFromLengthSubjects(obj,prop,watcher)},loop=function(){for(var i=0;i<lengthsubjects.length;i++){var subj=lengthsubjects[i];if("$$watchlengthsubjectroot"===subj.prop){var difference=getObjDiff(subj.obj,subj.actual);(difference.added.length||difference.removed.length)&&(difference.added.length&&watchMany(subj.obj,difference.added,subj.watcher,subj.level-1,!0),subj.watcher.call(subj.obj,"root","differentattr",difference,subj.actual)),subj.actual=clone(subj.obj)}else{var difference=getObjDiff(subj.obj[subj.prop],subj.actual);if(difference.added.length||difference.removed.length){if(difference.added.length)for(var j=0;j<subj.obj.watchers[subj.prop].length;j++)watchMany(subj.obj[subj.prop],difference.added,subj.obj.watchers[subj.prop][j],subj.level-1,!0);callWatchers(subj.obj,subj.prop,"differentattr",difference,subj.actual)}subj.actual=clone(subj.obj[subj.prop])}}},pushToLengthSubjects=function(obj,prop,watcher,level){var actual;actual=clone("$$watchlengthsubjectroot"===prop?obj:obj[prop]),lengthsubjects.push({obj:obj,prop:prop,actual:actual,watcher:watcher,level:level})},removeFromLengthSubjects=function(obj,prop,watcher){for(var i=0;i<lengthsubjects.length;i++){var subj=lengthsubjects[i];subj.obj==obj&&subj.prop==prop&&subj.watcher==watcher&&lengthsubjects.splice(i,1)}};return setInterval(loop,50),WatchJS.watch=watch,WatchJS.unwatch=unwatch,WatchJS.callWatchers=callWatchers,WatchJS}),define("widget/parsers/addChildren",[],function(){function addChildren(context,child,data){if(child&&child.name&&context){applyEvents(context,child,data),elReady(context,child,data);var handler=elOnChange(context,child);return handler&&handler(data),context.children[child.name]=child,child}}function elOnChange(context,child){return void 0!==context.elOnChange[child.name]?function(data){return context.elOnChange[child.name].call(context,child,data)}:!1}function elReady(context,child,data){void 0!==context.elReady[child.name]&&context.elReady[child.name].call(context,child,data)}function applyEvents(context,child,data){var events=context.events[child.name];void 0!==events&&void 0!==child.el&&"cp"!==child.data.type&&events.forEach(function(event){context._events.push(child.on(event.name,event.action,context,data))})}return Object.assign(addChildren,{elOnChange:elOnChange,elReady:elReady,applyEvents:applyEvents}),addChildren}),define("widget/parsers/applyAttribute",["watch","./addChildren"],function(WatchJS,addChildren){function applyAttribute(context,childBinder,data){var bind=childBinder.data.tplSet.bind,update="true"===childBinder.data.tplSet.update;bind&&Object.keys(bind).forEach(function(bindItem){var key=bind[bindItem],dataItem=data[key];switch(bindItem){case"class":var addClass=function(className){return void 0!==className&&""!==className?(childBinder.addClass(className),className):!1},currClass=addClass(dataItem);update===!0&&watch(data,key,function(){currClass&&childBinder.removeClass(currClass),currClass=addClass(data[key])});break;case"checked":void 0!==dataItem&&(childBinder.el.checked=dataItem),update===!0&&watch(data,key,function(){return childBinder.el.checked=data[key]});break;case"value":void 0!==dataItem&&(childBinder.el.value=dataItem),update===!0&&watch(data,key,function(){return childBinder.el.value=data[key]});break;case"required":void 0!==dataItem&&(childBinder.el.required=dataItem),update===!0&&watch(data,key,function(){return childBinder.el.required=data[key]});break;case"text":void 0!==dataItem&&childBinder.text(dataItem),update===!0&&watch(data,key,function(){return childBinder.text(data[key])});break;default:void 0!==dataItem&&childBinder.setAttribute(bindItem,dataItem),update===!0&&watch(data,key,function(){return childBinder.setAttribute(bindItem,data[key])})}void 0!==data.text&&"text"!==bindItem&&(childBinder.text(data.text),update===!0&&"text"!==bindItem&&watch(data,"text",function(){return childBinder.text(data.text)})),update===!0&&!function(){var handler=addChildren.elOnChange(context,childBinder);handler&&watch(data,key,function(){return handler(data)})}()})}var watch=WatchJS.watch;return applyAttribute}),define("widget/parsers/applyParent",["templating/dom","./addChildren"],function(dom,addChildren){function setChildren(context){var parentChildren=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],data=arguments.length<=2||void 0===arguments[2]?{}:arguments[2];context&&!function(){var elements=context.children;elements&&Object.keys(elements).forEach(function(name){var add=!0,child=elements[name],parentChild=parentChildren[name];void 0!==parentChild?void 0!==context.nodes[name]?context.nodes[name].call(context,child,parentChild,data):void 0!==child&&("string"==typeof parentChild?dom.text(child,parentChild):child=parentChild.run(child.el)):void 0!==context.nodes[name]&&"true"===child.data.tplSet.noattach&&(context.nodes[name].call(context,child,data),add=!1),add&&child.elGroup.size>0&&addChildren(context,child,data)})}()}return setChildren}),define("widget/utils",[],function(){function extend(obj){var type="undefined"==typeof obj?"undefined":_typeof(obj);if(!("function"===type||"object"===type&&obj))return obj;for(var source,prop,i=1,length=arguments.length;length>i;i++){source=arguments[i];for(prop in source)obj[prop]=source[prop]}return obj}function fnExtend(protoProps,staticProps){var child,parent=this;child=protoProps&&null!=protoProps&&hasOwnProperty.call(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&extend(child.prototype,protoProps),child.__super__=parent.prototype,child}function isString(obj){return"[object String]"===toString.call(obj)}function isObject(obj){return obj===Object(obj)}function isArray(obj){return Array.isArray?Array.isArray(obj):"[object Array]"===toString.call(obj)}return{fnExtend:fnExtend,extend:extend,isString:isString,isObject:isObject,isArray:isArray}}),define("widget/parsers/setBinders",[],function(){function setBinders(children,ignoreCP){var bindings={};return Object.defineProperty(bindings,"__cp__",{enumerable:!1,value:[]}),Object.keys(children).forEach(function(key){var el=children[key];el&&el.data&&void 0!==el.data.bind&&"cp"!==el.data.type?(bindings[el.data.bind]=bindings[el.data.bind]||[],bindings[el.data.bind].push(el)):ignoreCP||"cp"!==el.data.type||bindings.__cp__.push(el)}),bindings}return setBinders}),define("widget/parsers/applyBinders",["templating/dom","../utils","watch","./setBinders","./addChildren","./applyAttribute"],function(dom,utils,WatchJS,setBinders,addChildren,applyAttribute){function parseBinder(context,objKey,obj,binder){if(void 0!==binder){var data=obj[objKey];if(context.nodes[objKey])context.nodes[objKey].call(context,binder,data);else if(utils.isArray(data)||utils.isObject(data)){if(utils.isArray(data))!function(){var bindedData=[],addItem=function(item,index){var isString=!1;utils.isArray(item)||utils.isObject(item)||(isString=!0);var element=binder.run(!0,index);isString&&element.text(item),bindedData.push({binder:element,data:item}),applyAttribute(context,element,item),addChildren.applyEvents(context,element,item),addChildren.elReady(context,element,item);var handler=addChildren.elOnChange(context,element);handler&&handler(item),element.children&&(element.bindings=setBinders(element.children),applyBinders(context,item,element))};data.forEach(addItem);var update=binder.data.tplSet.update;"true"===update&&!function(){
var removeMethodNames=["pop","shift","splice"],insertMethodNames=["push","unshift"],sortingMethodNames=["reverse","sort"];watch(obj,objKey,function(prop,action,newValue,oldValue){var clonedData=bindedData.slice(0);if(void 0===oldValue&&-1!==insertMethodNames.indexOf(action)){var filter=clonedData.filter(function(item){return item.data===newValue[0]});0===filter.length&&addItem(newValue[0],"unshift"===action?0:clonedData.length)}else if(-1!==removeMethodNames.indexOf(action)){if(clonedData.forEach(function(binder){-1===obj[objKey].indexOf(binder.data)&&(binder.binder.remove(),bindedData.splice(bindedData.indexOf(binder),1))}),"splice"===action){var vals=Array.prototype.slice.call(newValue,2);vals&&vals.length>0&&vals.forEach(function(val){var index=obj[objKey].indexOf(val);-1!==index&&addItem(val,index)})}}else-1!==sortingMethodNames.indexOf(action)&&data.forEach(function(value,index){var element=clonedData.filter(function(item){return item.data===value})[0];bindedData.splice(index,0,bindedData.splice(bindedData.indexOf(element),1)[0]),element.binder.changePosition(index)})})}()}();else if(utils.isObject(data)){var _element=binder.run(data);if("cp"!==_element.data.type){applyAttribute(context,_element,data),addChildren.applyEvents(context,_element,data),addChildren.elReady(context,_element,data);var _handler=addChildren.elOnChange(context,_element);_handler&&_handler(data),_element.children&&(_element.bindings=setBinders(_element.children),applyBinders(context,data,_element))}}}else!function(){var element=binder.run(!0);element.text(data),addChildren.applyEvents(context,element,data),addChildren.elReady(context,element,data);var handler=addChildren.elOnChange(context,element);handler&&handler(data),"true"===element.data.tplSet.update&&watch(obj,objKey,function(){element.text(obj[objKey]);var handler=addChildren.elOnChange(context,element);handler&&handler(obj[objKey])})}()}}function applyBinders(child,obj,instance){var binders=instance.bindings;if(binders){binders.__cp__.length>0&&binders.__cp__.forEach(function(binder){var component=binder.run(obj);component.setContext(child.context),addChildren.elReady(child,component,obj);var handler=addChildren.elOnChange(child,component);handler&&handler(obj)});var keys=Object.keys(binders);obj&&keys.length>0&&keys.forEach(function(binderKey){void 0!==obj[binderKey]?binders[binderKey].forEach(function(binder){return parseBinder(child,binderKey,obj,binder)}):!function(){var fn=function fn(prop,action,newValue,oldValue){void 0!==newValue&&void 0===oldValue&&(binders[binderKey].forEach(function(binder){return parseBinder(child,binderKey,obj,binder)}),unwatch(obj,binderKey,fn))};watch(obj,binderKey,fn,0)}()})}}var watch=WatchJS.watch,unwatch=WatchJS.unwatch;return applyBinders}),define("widget/parsers/setRoutes",["templating/dom"],function(dom){function getArgs(func){var fnStr=func.toString().replace(STRIP_COMMENTS,""),argsList=fnStr.slice(fnStr.indexOf("(")+1,fnStr.indexOf(")")),result=argsList.match(ARGUMENT_NAMES);return null===result?[]:result.map(function(item){return item.replace(/[\s,]/g,"")})}function destroyComponent(cp){void 0!==cp.remove&&cp.remove()}function applyToChildren(children,cb){void 0!==children&&Object.keys(children).forEach(function(name){var instance=children[name];applyToGroup(instance,cb)||cb(instance)})}function applyToGroup(child,cb){return child.elGroup&&child.elGroup.size>0?(child.elGroup.forEach(function(childInstance){cb(childInstance)}),!0):!1}function matchRoute(child,context){child.setContext?child.setContext(context):!function(){var route=void 0!==child.data?child.data.route:void 0;void 0!==route&&"rt"===child.data.type?!function(){var id=void 0,match=context.match,active=context.active,matches=match(route);matches.to(function(){for(var _len3=arguments.length,args=Array(_len3),_key3=0;_len3>_key3;_key3++)args[_key3]=arguments[_key3];var params=args.pop();if(id=args.length>0?params.getLocation()+"_"+args.join("_"):void 0,!applyToGroup(child,function(instance){return dom.attach(instance)})){var childInstance=child.run(!0);applyToChildren(childInstance.children,function(instance){instance&&match(route,function(match){return matchRoute(instance,{match:match,active:active})})})}applyToGroup(child,function(childInstance){applyToChildren(childInstance.children,function(instance){instance&&instance.to&&instance.to.apply(instance,_toConsumableArray(args.concat(params)))})})}),matches.leave(function(done){var items=0,stopped=!1;applyToGroup(child,function(childInstance){var finish=function(){id?destroyComponent(childInstance):dom.detach(childInstance)},close=function close(){var close=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];close?items--:(stopped=!0,done(!1)),0!==items||stopped||(active.set(childInstance,finish),done(!0))};applyToChildren(childInstance.children,function(instance){if(instance&&void 0!==instance.leave){var args=getArgs(instance.leave);args.length>0&&items++,instance.leave(close)}}),0===items&&(active.set(childInstance,finish),done(!0))})}),matches.query(function(params){applyToGroup(child,function(childInstance){applyToChildren(childInstance.children,function(instance){instance&&void 0!==instance.query&&instance.query(params)})})}),applyToGroup(child,function(instance){return instance._activeRoute=matches})}():void 0!==child.children&&-1===["cp"].indexOf(child.data.type)&&applyToChildren(child.children,function(instance){return matchRoute(instance,context)})}()}function setRoutes(children,context){applyToChildren(children,function(child){return matchRoute(child,context)})}var STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,ARGUMENT_NAMES=/(?:^|,)\s*([^\s,=]+)/g;return setRoutes}),define("widget/parsers/applyElement",["templating/dom"],function(dom){function applyElement(){var elements=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],params=arguments[1],instances={};return Object.keys(elements).forEach(function(key){var instance=elements[key];"string"!=typeof instance&&!function(){var element=instance.elGroup.first;element?(instances[key]=element,element instanceof dom.Element==!0&&-1!==["pl"].indexOf(element.data.type)&&!function(){var bind=element.data.tplSet.bind;bind&&Object.keys(bind).forEach(function(attr){void 0!==params[bind[attr]]&&("class"!==attr?element.setAttribute(attr,params[bind[attr]]):element.addClass(params[bind[attr]]))})}()):instances[key]=instance}()}),instances}return applyElement}),define("widget/Constructor",["require","templating/Decoder","templating/dom","./Mediator","./parsers/applyAttribute","./parsers/applyParent","./parsers/applyBinders","./parsers/setBinders","./parsers/setRoutes","./parsers/applyElement","./parsers/addChildren"],function(require,Decoder,dom,Mediator,applyAttribute,applyParent,_applyBinders,setBinders,setRoutes,applyElement,addChildren){function _destroy(instance){var keys=Object.keys(instance);keys.length>0&&keys.forEach(function(key){if("root"!==key){var children=instance[key];void 0!==children.elGroup&&children.elGroup.size>0&&children.elGroup.forEach(function(child){void 0!==child&&void 0!==child.remove&&child.remove(!0)})}})}var Constructor=function(){function Constructor(){var options=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],parentChildren=arguments[1],dataSet=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],node=arguments[3];_classCallCheck(this,Constructor),this.instance=this,this._events=[],this._globalEvents=[],this._parentChildren=parentChildren,this._options=options,this._rendered=!1,this._arguments=Array.from(arguments),this._dataSet=dataSet,this.eventBus=new Mediator(this),void 0!==node&&void 0!==node.name&&(this.name=node.name),this.beforeInit.apply(this,_toConsumableArray(this._arguments))}return _createClass(Constructor,null,[{key:"extend",value:function(){var options=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],Surrogate=function(_Constructor){function Surrogate(){return _classCallCheck(this,Surrogate),_possibleConstructorReturn(this,Object.getPrototypeOf(Surrogate).apply(this,arguments))}return _inherits(Surrogate,_Constructor),Surrogate}(Constructor);return Object.assign(Surrogate.prototype,options),Surrogate}}]),_createClass(Constructor,[{key:"ready",value:function(el){this.el=el}},{key:"setContext",value:function(context){this.context=context,this.async||this.render(),this.init.apply(this,_toConsumableArray(this._arguments))}},{key:"render",value:function(data){if(!this._rendered&&this.template){data&&(this.data=data);var options=this._options,parentChildren=this._parentChildren,decoder=new Decoder(this.template),template=decoder.render(this.data);if(this.el){var parent=this.el.parentNode;parent&&parent.replaceChild(template.fragment,this.el),this.elGroup&&this.elGroup.get(this.el)&&(this.elGroup["delete"](this.el),this.el=template.fragment,this.elGroup.set(template.fragment,this))}else this.el=template.fragment;this.root=new dom.Element(template.fragment,{name:"root",data:{}}),this.children=applyElement(template.children,options),applyParent(this,parentChildren,this.data),this.bindings=setBinders(this.children,!0),this.data&&this.applyBinders(this.data,this),setRoutes(this.children,this.context),addChildren(this,this.root),this.rendered.apply(this,_toConsumableArray(this._arguments)),this._rendered=!0}}},{key:"beforeInit",value:function(data,children,dataSet){}},{key:"init",value:function(data,children,dataSet){}},{key:"rendered",value:function(data,children,dataSet){}},{key:"loadCss",value:function(url){if(this.context._cssReady=this.context._cssReady||[],-1===this.context._cssReady.indexOf(url)){this.context._cssReady.push(url);var linkRef=document.createElement("link");linkRef.setAttribute("rel","stylesheet"),linkRef.setAttribute("type","text/css"),linkRef.setAttribute("href",url),"undefined"!=typeof linkRef&&document.getElementsByTagName("head")[0].appendChild(linkRef)}}},{key:"detach",value:function(){this._placeholder||(this._placeholder=document.createElement(this.el.tagName)),this._parent||(this._parent=this.el.parentNode),this.el&&this._parent&&this._parent.replaceChild(this._placeholder,this.el)}},{key:"attach",value:function(){this._placeholder&&this._parent&&this._parent.replaceChild(this.el,this._placeholder)}},{key:"onDestroy",value:function(){}},{key:"destroy",value:function(){for(this.onDestroy(),this.eventBus.clear();this._events.length>0;)this._events.shift().remove();for(;this._globalEvents.length>0;)this._globalEvents.shift().remove();_destroy(this.children),void 0!==this.elGroup&&void 0!==this.el&&this.elGroup["delete"](this.el),this.root&&this.root.remove&&this.root.remove(),delete this.el}},{key:"remove",value:function(){this.destroy.apply(this,arguments)}},{key:"setChildren",value:function(el,data){var name=el.data.name,instance=this.children[name];void 0!==instance&&void 0!==instance.el&&instance.remove(),instance=el.run(data||!0),addChildren(this,instance,data)}},{key:"addComponent",value:function(Component,options){var name=options.name,container=options.container;if(void 0===name)throw"you have to define data.name for component.";if(void 0===container)throw"You have to define container for component.";if(void 0!==this.children[name])throw"Component using name:"+name+"! already defined.";var component=this.setComponent(Component,options),instance=component.run(options.container);return instance.setContext(this.context),this.children[name]=instance,instance}},{key:"setComponent",value:function(Component,options){var _this8=this,instance={name:options.name,data:{tag:"div",type:"cp"},run:function(container){options.appContext=_this8.context;var cp=new Component(options,options.children,options.data),el=document.createElement("div");return el.setAttribute("style","display:none;"),cp.ready(el),container instanceof HTMLElement==!0?container.parentNode.replaceChild(cp.el,container):void 0!==container.el&&void 0!==options.pos?dom.insertBefore(container,cp,options.pos):void 0!==container.el&&dom.append(container,cp),cp}};return instance}},{key:"applyBinders",value:function(){for(var _len4=arguments.length,args=Array(_len4),_key4=0;_len4>_key4;_key4++)args[_key4]=arguments[_key4];return _applyBinders.apply(void 0,[this].concat(args))}},{key:"context",set:function(context){var _this9=this;if(!this.data){var keys=this._dataSet?Object.keys(this._dataSet):[],contextData=keys.length>0?this._dataSet:context.data;contextData&&(this.data=contextData[this._options.bind]||contextData)}context.match(function(match){_this9.match&&_this9.match(match),_this9._context=Object.assign({match:match},context)})},get:function(){return this._context}}]),Constructor}();return Object.assign(Constructor.prototype,{nodes:{},events:{},elReady:{},elOnChange:{}}),Constructor}),function(global,factory){"function"==typeof define&&define.amd?define("widget/Mediator",[],function(){return factory()}):"undefined"!=typeof exports?exports.Mediator=factory():global.Mediator=factory()}(void 0,function(){var Subscriber=function(){function Subscriber(fn,options){var context=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],channel=arguments.length<=3||void 0===arguments[3]?null:arguments[3];_classCallCheck(this,Subscriber),this.fn=fn,this.channel=channel,this.context=context,this.options=options}return _createClass(Subscriber,[{key:"update",value:function(){var options=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];Object.assign(this,options),this.channel&&this.setPriority(this.priority)}},{key:"setHook",value:function(context){var channel=this.channel;channel&&channel.hook(this,context)}},{key:"_reduceCalls",value:function(){void 0!==this.calls&&(this.calls--,this.calls<1&&this.remove())}},{key:"remove",value:function(){var channel=this.channel;channel&&channel.removeSubscriber(this)}},{key:"setPriority",value:function(priority){var channel=this.channel;channel&&channel.setPriority(this,priority)}},{key:"run",value:function(data){this.channel.stopped||"function"==typeof this.predicate&&!this.predicate.apply(this.context,data)||(this._reduceCalls(),this.fn.apply(this.context,data))}},{key:"options",set:function(options){this.update(options)}},{key:"context",set:function(context){this.setHook(context),this._context=context},get:function(){return this._context}}]),Subscriber}(),Channel=function(){function Channel(namespace,parent,context,hook){_classCallCheck(this,Channel),this.namespace=namespace||"",this._subscribers=[],this._channels=new Map,this._parent=parent,this.stopped=!1,this.context=context,this.hook=hook}return _createClass(Channel,[{key:"addSubscriber",value:function(fn,options){var context=arguments.length<=2||void 0===arguments[2]?this.context:arguments[2];return new Subscriber(fn,options,context,this)}},{key:"stopPropagation",value:function(){this.stopped=!0}},{key:"setPriority",value:function(subscriber,priority){var subscribers=this._subscribers,index=subscribers.indexOf(subscriber);-1!==index&&subscribers.splice(subscribers.indexOf(subscriber),1),void 0!==priority&&priority<this._subscribers.length?subscribers.splice(priority,0,subscriber):subscribers.push(subscriber)}},{key:"hasChannel",value:function(channel){return this._channels.has(channel)}},{key:"getChannel",value:function(channel){return this._channels.get(channel)}},{key:"setChannel",value:function(namespace,readOnly){if(this.hasChannel(namespace)||readOnly)return this.getChannel(namespace);var channel=new Channel((this.namespace?this.namespace+":":"")+namespace,this,this.context,this.hook);return this._channels.set(namespace,channel),channel}},{key:"returnChannel",value:function returnChannel(channels,readOnly){if(channels&&channels.length>0){var channel=channels.shift(),returnChannel=this.setChannel(channel,readOnly);return returnChannel&&channels.length>0?returnChannel.returnChannel(channels,readOnly):returnChannel}}},{key:"removeSubscriber",value:function(subscriber){var subscribers=this._subscribers,index=subscribers.indexOf(subscriber);subscriber?-1!==index&&subscribers.splice(index,1):subscribers.splice(0,subscribers.length),0===this._subscribers.length&&this._parent&&this._parent.removeChannel(this)}},{key:"removeChannel",value:function(channel){channel===this.getChannel(channel.namespace)&&this._channels["delete"](channel.namespace)}},{key:"clear",value:function(){this._channels.forEach(function(channel){return channel.clear()}),this.removeSubscriber()}},{key:"publish",value:function(data){this._subscribers.slice().forEach(function(subscriber){return subscriber.run(data)}),this._parent&&this._parent.publish(data),this.stopped=!1}}]),Channel}(),Mediator=function(){function Mediator(){var context=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],hook=arguments.length<=1||void 0===arguments[1]?function(){}:arguments[1];return _classCallCheck(this,Mediator),this instanceof Mediator?void(this.channel=new Channel("",!1,context,hook)):new Mediator(context,hook)}return _createClass(Mediator,[{key:"getChannel",value:function(namespace,readOnly){var namespaceHierarchy=namespace.split(":");return namespaceHierarchy.length>0?this.channel.returnChannel(namespaceHierarchy,readOnly):void 0}},{key:"subscribe",value:function(channelName,fn){var options=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],context=arguments[3];if(channelName&&""!==channelName){var channel=this.getChannel(channelName,!1);return channel.addSubscriber(fn,options,context)}throw Error("Namespace should be provided!")}},{key:"once",value:function(channelName,fn){var options=arguments.length<=2||void 0===arguments[2]?{}:arguments[2],context=arguments[3];return options.calls=1,this.subscribe(channelName,fn,options,context)}},{key:"publish",value:function(channelName){if(channelName&&""!==channelName){var channel=this.getChannel(channelName,!0);if(channel&&channel.namespace===channelName){for(var _len5=arguments.length,args=Array(_len5>1?_len5-1:0),_key5=1;_len5>_key5;_key5++)args[_key5-1]=arguments[_key5];args.push(channel),channel.publish(args)}}}},{key:"clear",value:function(){this.channel.clear()}}]),Mediator}();return Mediator.prototype.on=Mediator.prototype.subscribe,Mediator.prototype.trigger=Mediator.prototype.publish,Mediator.version="0.9.9",Mediator}),function(root,factory){"function"==typeof define&&define.amd?define("router/utils",[],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory())}(void 0,function(){function parseParams(value){try{return decodeURIComponent(value.replace(/\+/g," "))}catch(err){return value}}function iterateQueryString(queryString,callback){var keyValues=queryString.split("&");keyValues.forEach(function(keyValue){var arr=keyValue.split("=");callback(arr.shift(),arr.join("="))})}function setQuery(parts){var query={};return parts&&iterateQueryString(parts,function(name,value){value=parseParams(value),query[name]?"string"==typeof query[name]?query[name]=[query[name],value]:query[name].push(value):query[name]=value}),query}function serialize(obj){var str=[];for(var p in obj)obj.hasOwnProperty(p)&&str.push(encodeURIComponent(p)+"="+encodeURIComponent(obj[p]));return str.join("&")}function getLocation(params,pattern){return{getQuery:function(){return params.query},getLocation:function(){var fragment=arguments.length<=0||void 0===arguments[0]?"":arguments[0],isQuery=arguments[1],current=params.root.substring(0,params.root.length-pattern.length),newQuery=void 0;return newQuery=isQuery===!0?serialize(params.query):isQuery===!1?"":serialize(isQuery),current+fragment+(0===newQuery.length?"":"?"+newQuery)}}}function equals(arr1,arr2){if(!arr2)return!1;if(arr1.length!==arr2.length)return!1;for(var i=0,l=arr1.length;l>i;i++)if(arr1[i]instanceof Array&&arr2[i]instanceof Array){if(!equals(arr1[i],arr2[i]))return!1}else if(arr1[i]!==arr2[i])return!1;return!0}function getArgs(func){var fnStr=func.toString().replace(STRIP_COMMENTS,""),argsList=fnStr.slice(fnStr.indexOf("(")+1,fnStr.indexOf(")")),result=argsList.match(ARGUMENT_NAMES);return null===result?[]:result.map(function(item){return item.replace(/[\s,]/g,"")})}var STRIP_COMMENTS=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,ARGUMENT_NAMES=/(?:^|,)\s*([^\s,=]+)/g;return{serialize:serialize,getLocation:getLocation,equals:equals,setQuery:setQuery,getArgs:getArgs}}),function(root,factory){"function"==typeof define&&define.amd?define("router/MatchBinding",["./utils"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./utils")))}(void 0,function(utils){var MatchBinding=function(){function MatchBinding(pattern,location,binder){if(_classCallCheck(this,MatchBinding),binder&&(this.binder=binder),""===location)this.pattern=pattern.replace(/^\(\/\)/g,"").replace(/^\/|$/g,"");else{var match=pattern.match(/^(\/|\(\/)/g);null===match&&(pattern="("===pattern[0]?"(/"+pattern.substring(1):"/"+pattern),this.pattern=pattern}var route=this.pattern.replace(MatchBinding.ESCAPE_PARAM,"\\$&").replace(MatchBinding.OPTIONAL_PARAM,"(?:$1)?").replace(MatchBinding.NAMED_PARAM,function(match,optional){return optional?match:"([^/]+)"}).replace(MatchBinding.SPLAT_PARAM,"(.*)");this.patternRegExp=new RegExp("^"+route),this.routeHandler=new Set,this.leaveHandler=new Set,this.queryHandler=new Set,this._active=!1}return _createClass(MatchBinding,[{key:"setRoutes",value:function(mapHandler){var subBinder=this.subBinder;return mapHandler({match:subBinder.match.bind(subBinder)}),this}},{key:"reTrigger",value:function(){this.binder.reTrigger()}},{key:"match",value:function(_match){var subBinder=this.subBinder;return _match(subBinder.match.bind(subBinder)),this}},{key:"to",value:function(routeHandler){return this.routeHandler.add({handler:routeHandler,done:!1}),this.reTrigger(),this}},{key:"leave",value:function(leaveHandler){var args=utils.getArgs(leaveHandler);return this.leaveHandler.add({handler:leaveHandler,done:args.length>0&&"done"===args[0]}),this}},{key:"query",value:function(queryHandler){return this.queryHandler.add({handler:queryHandler,done:!1}),this}},{key:"remove",value:function(){return this.routeHandler.clear(),this.leaveHandler.clear(),this.queryHandler.clear(),this.subBinder.remove(),this}},{key:"test",value:function(location){return this.patternRegExp.test(location)}},{key:"getFragment",value:function(location){var matches=location.match(this.patternRegExp);return null===matches?"":location.substring(matches[0].length)}},{key:"extractParams",value:function(fragment){var params=this.patternRegExp.exec(fragment);return params&&params.length>0?params.slice(1).map(function(param){return param?decodeURIComponent(param):null}):[]}},{key:"setSubBinder",value:function(MatchBinder,pattern,mapHandler){var subBinder=new MatchBinder(pattern,this);return this.subBinder=subBinder,"function"==typeof mapHandler&&mapHandler(subBinder.match.bind(subBinder)),subBinder}},{key:"checkSegment",value:function(matched,params){var status=[];if(this._active){var pattern=this.pattern.replace(/\((.*?)\)/g,"$1").replace(/^\//,"").split("/"),prevLoc=this.prevLoc.replace(/^\//,"").split("/"),currSegment=matched.slice(0,pattern.length),prevSegment=prevLoc.slice(0,pattern.length),equals=utils.equals(currSegment,prevSegment);equals?matched.length>1?status=this.subBinder.checkStatus(matched.slice(pattern.length),params):equals&&(status=this.subBinder.clearActive(params)):status=this.clearActive(params)}return status}},{key:"clearActive",value:function(params){var active=[];return this._active&&active.push({handler:this.triggerLeave(params),disable:this.disable.bind(this)}),active.concat(this.subBinder.clearActive())}},{key:"disable",value:function(){this._active=!1}},{key:"triggerTo",value:function(location,params){if(this.test(location)){if(!this._active){this.prevLoc=location;var args=this.extractParams(location).concat(utils.getLocation(params,location));this.applyHandlers(this.routeHandler,args),this._active=!0}this.applyHandlers(this.queryHandler,[utils.getLocation(params,location)]);var fragment=this.getFragment(location);if(""!==fragment.trim()){var subBinder=this.subBinder;subBinder&&subBinder.triggerRoutes(fragment,params)}}}},{key:"applyHandlers",value:function(handlers){var _this10=this,args=arguments.length<=1||void 0===arguments[1]?[]:arguments[1];handlers&&handlers.size>0&&handlers.forEach(function(item){item.handler.apply(_this10,args)})}},{key:"triggerLeave",value:function(params){var _this11=this;return new Promise(function(resolve){var handlers=_this11.leaveHandler,location=utils.getLocation(params,_this11.prevLoc),items=0,stopped=!1;handlers&&handlers.size>0&&handlers.forEach(function(item){item.done&&items++,item.handler(function(){var done=arguments.length<=0||void 0===arguments[0]?!0:arguments[0];done?(items--,0!==items||stopped||resolve(!0)):done||stopped||(stopped=!0,resolve(!1))},location)}),0===items&&resolve(!0)})}}]),MatchBinding}();return Object.assign(MatchBinding,{OPTIONAL_PARAM:/\((.*?)\)/g,NAMED_PARAM:/(\(\?)?:\w+/g,SPLAT_PARAM:/\*\w+/g,ESCAPE_PARAM:/[\-{}\[\]+?.,\\\^$|#\s]/g}),MatchBinding}),function(root,factory){"function"==typeof define&&define.amd?define("router/MatchBinder",["./MatchBinding"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=factory(require("./MatchBinding")):(root.UrlManager=root.UrlManager||{},root.UrlManager.MatchBinder=factory(root.UrlManager.MatchBinding))}(void 0,function(MatchBinding){var MatchBinder=function(){function MatchBinder(location,parent){_classCallCheck(this,MatchBinder),this._parent=parent,this.bindings=new Set,this.location=location||"",this._active=!1}return _createClass(MatchBinder,[{key:"reTrigger",value:function(){this._parent.reTrigger()}},{key:"match",value:function(pattern,mapHandler){return"function"==typeof pattern&&(mapHandler=pattern,pattern=!1),""===pattern&&(pattern=!1),this.getMatchBinding(pattern,mapHandler)}},{key:"getMatchBinding",value:function(pattern,mapHandler){if(pattern){var binding=new MatchBinding(pattern,this.location,this);return binding.setSubBinder(MatchBinder,this.location+(pattern||""),mapHandler),this.bindings.add(binding),binding}return"function"==typeof mapHandler&&mapHandler(this.match.bind(this)),{match:this.match.bind(this)}}},{key:"clearActive",value:function(params,location){var active=[];return this.bindings.size>0&&this.bindings.forEach(function(binding){active=active.concat(binding.clearActive(params,location))}),active}},{key:"checkStatus",value:function(matched,params){var active=[];return this.bindings.size>0&&this.bindings.forEach(function(binding){active=active.concat(binding.checkSegment(matched,params))}),active}},{key:"remove",value:function(){this.bindings.size>0&&this.bindings.forEach(function(binding){return binding.remove()})}},{key:"triggerRoutes",value:function(location,params){this.bindings.size>0&&this.bindings.forEach(function(binding){return binding.triggerTo(location,params)})}}]),MatchBinder}();return MatchBinder}),function(root,factory){"function"==typeof define&&define.amd?define("router/Router",["./MatchBinder","./utils"],factory):"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(module.exports=factory(require("./MatchBinder"),require("./utils")))}(void 0,function(MatchBinder,utils){var Router=function(){function Router(location){_classCallCheck(this,Router),void 0!==location&&""!==location&&(this._location=location.replace(/^\/|\/$/g,"")+"/"),this.root=this.getBinder(),this._listeners=new Set,this._handlers=new Set}return _createClass(Router,[{key:"getBinder",value:function(){return new MatchBinder("",this)}},{key:"test",value:function(loc){return new RegExp("^"+this._location,"g").test(loc)}},{key:"getLocation",value:function(loc){var location=loc.replace(/^\/|$/g,"");return void 0!==this._location?this.test(location)?location.replace(this._location,""):!1:location}},{key:"reTrigger",value:function(){this.currLocation&&this.trigger(this.currLocation)}},{key:"trigger",value:function(location){var _this12=this;this.started&&!function(){_this12.currLocation=location;var parts=location.split("?",2),segments=_this12.getLocation(parts[0]);(segments||""===segments)&&!function(){var query=utils.setQuery(parts[1]),params={root:segments,query:query};_this12.execute(segments,params).then(function(move){return _this12.setRoutes(move,segments,params)}).then(function(move){return _this12.setLocation(move)})}()}()}},{key:"execute",value:function(location,params){var _this13=this;return new Promise(function(resolve){var matched=location.replace(/^\/|$/g,"").split("/"),binder=_this13.root,active=binder.checkStatus(matched,params);active.length>0?active.forEach(function(item){item.handler.then(function(applied){item.triggered||(item.triggered=!0,item.applied=applied,active.filter(function(item){return item.applied}).length===active.length?(active.forEach(function(item){return item.disable()}),resolve(!0)):active.filter(function(item){return item.triggered}).length===active.length&&resolve(!1))})}):resolve(!0)})}},{key:"setRoutes",value:function(move,location,params){return move&&(this._handlers.forEach(function(handler){return handler()}),this.root.triggerRoutes(location,params)),move}},{key:"setListener",value:function(listener){var listeners=this._listeners;return listeners.add(listener),{remove:function(){listeners["delete"](listener)}}}},{key:"onRouteChange",value:function(handler){var handlers=this._handlers;return handlers.add(handler),{remove:function(){handlers["delete"](handler)}}}},{key:"setLocation",value:function(move){var location=move?this.currLocation:this.prevLocation;this.prevLocation=location,this._listeners.forEach(function(listener){return listener(location,move)})}},{key:"match",value:function(mapHandler){mapHandler(this.root.match.bind(this.root))}},{key:"start",value:function(){this.started=!0}},{key:"stop",value:function(){this.started=!1}}]),Router}();return Router}),define("widget/App",["./Mediator","router/Router"],function(Mediator,Router){function triggerRoute(router,active){function onHashChange(){var match=window.location.href.match(/#(.*)$/),route=match?match[1]:"";activeLocation!==route&&router.trigger(route)}var activeLocation="";router.setListener(function(location,move){activeLocation=location,move||(window.location.hash=location)}),router.onRouteChange(function(){active.size>0&&(active.forEach(function(handler){return handler()}),active.clear())}),router.start(),window.addEventListener("hashchange",onHashChange,!1),onHashChange()}var App=function(){function App(){var options=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];_classCallCheck(this,App),this.options=options,this.beforeInit.apply(this,arguments)}return _createClass(App,null,[{key:"extend",value:function(){var options=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],Surrogate=function(_App){function Surrogate(){return _classCallCheck(this,Surrogate),_possibleConstructorReturn(this,Object.getPrototypeOf(Surrogate).apply(this,arguments))}return _inherits(Surrogate,_App),Surrogate}(App);return Object.assign(Surrogate.prototype,options),Surrogate}}]),_createClass(App,[{key:"beforeInit",value:function(){}},{key:"init",value:function(){}},{key:"setContext",value:function(){return{}}},{key:"start",value:function(container){if(container instanceof HTMLElement!=!0)throw Error("Contaner should be a HTML element");this.el=container,this.context=this.setContext.apply(this,arguments),void 0!==this.AppContainer&&(this.appContainer=new this.AppContainer),this.init.call(this,this.options);var el=document.createElement("div");this.el.appendChild(el),this.appContainer.ready(el),this.appContainer.setContext(this.context),setTimeout(function(){container.classList.add("show")},100)}},{key:"context",set:function(context){var _this15=this,router=new Router(this.options.rootRoute);router.match(function(match){Object.assign(context,{eventBus:new Mediator(_this15.context,function(channel,scope){scope._globalEvents=scope._globalEvents||[],-1===scope._globalEvents.indexOf(channel)&&scope._globalEvents.push(channel)}),active:new Map,
match:match,container:_this15.el}),triggerRoute(router,context.active),_this15._context=context})},get:function(){return this._context}}]),App}();return App});